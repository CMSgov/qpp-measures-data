#!/usr/bin/env bash

# Note: 
# For 2019, benchmarks are generated by a master benchmark.csv in staging/.
# This csv is used to generate a the benchmarks JSON. 
# Merging is no longer supported.

# For 2019, the first historical benchmarks are generated by calculate-deciles-lib.js in
# the qpp-submissions-api repo, then the result is exported to the /benchmarks
# directory in this repo. Subsequent updated benchmarks for 2019 will
# be generated by this build:benchmarks script.

# Updates to 2017-2018 benchmarks are not supported. 
# If you wish to update benchmarks for 2017-2018, please revert commit history to before this
# comment was made by using git-annotate. 
# The old flow to generate benchmarks:
# input.csv => node scripts/parse-benchmarks-data.js => output.json
# staging/${YEAR}/benchmarks/json/output.json => npm run build:benchmarks => benchmarks/${YEAR}.json

performanceYear=$1

if [[ -z "$performanceYear" ]]; then
  echo 'Performance year unspecified.'
  exit 126
else
  stagingDirectory=staging/${performanceYear}/benchmarks
  benchmarkYear=$(($performanceYear-2))
  csvFilename=${stagingDirectory}/benchmarks.csv
  benchmarkBaseFilename=${stagingDirectory}/json/benchmarks.json
  benchmarkFilename=benchmarks/${performanceYear}.json

  # generate benchmarks base
  echo 'Generating new benchmarks JSON.'
  cat $csvFilename | node scripts/benchmarks/parse-benchmarks-data.js $benchmarkYear $performanceYear > $benchmarkBaseFilename 

  echo 'Squashing staging JSON.'
  node scripts/benchmarks/merge-benchmark-data.js $performanceYear > $benchmarkFilename
 
  # validate benchmarks
  echo 'Validating new benchmarks JSON.'
  cat $benchmarkFilename | node scripts/validate-data.js benchmarks $performanceYear
fi
